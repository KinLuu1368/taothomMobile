<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>ƒêƒÉng K√Ω T√†i Kho·∫£n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body ng-app="app">
    <main class="container d-flex justify-content-center align-items-center mt-5">
        <form ng-controller="ctrl" ng-submit="register()" class="w-100" style="max-width: 500px;">
            <div class="card">
                <div class="card-header bg-primary text-white text-center">
                    <h5 class="mb-0">ƒêƒÇNG K√ù T√ÄI KHO·∫¢N</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">T√†i kho·∫£n:</label>
                        <input id="username" name="username" ng-model="form.username" class="form-control" required
                            ng-change="suggestFullname()">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">M·∫≠t kh·∫©u:</label>
                        <input id="password" name="password" type="password" ng-model="form.password"
                            class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u:</label>
                        <input id="confirmPassword" name="confirmPassword" type="password"
                            ng-model="form.confirmPassword" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="fullname" class="form-label">T√™n ƒë·∫ßy ƒë·ªß:</label>
                        <input id="fullname" name="fullname" ng-model="form.fullname" class="form-control" required>

                        <!-- Ph·∫ßn hi·ªÉn th·ªã g·ª£i √Ω d∆∞·ªõi √¥ nh·∫≠p -->
                        <div ng-if="suggestedFullname" class="suggestion" style="cursor: pointer; color: blue;"
                            ng-click="applySuggestion()">
                            T√™n G·ª£i √Ω: {{ suggestedFullname }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email:</label>
                        <input id="email" name="email" ng-model="form.email" type="email" class="form-control" required>
                        <button type="button" class="btn btn-primary mt-2" ng-click="sendCode()">L·∫•y m√£ x√°c
                            nh·∫≠n</button>
                    </div>
                    <div class="mb-3">
                        <label for="verificationCode" class="form-label">M√£ x√°c nh·∫≠n:</label>
                        <input id="verificationCode" name="verificationCode" ng-model="form.verificationCode"
                            class="form-control" required>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <button type="submit" class="btn btn-success">ƒêƒÉng k√Ω</button>
                </div>
            </div>
        </form>
    </main>

    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>



    <script>
        const app = angular.module("app", []);

        app.controller("ctrl", function ($scope, $http) {
            $scope.form = {};

//-------------------------------------------------------------------------------------------------------

            // H√†m g·ª≠i m√£ x√°c nh·∫≠n qua email
            $scope.sendCode = function () {
                if ($scope.form.email) {
                    $http.post('/rest/accounts/send-code?email=' + $scope.form.email)
                        .then(resp => {
                            console.log(resp.data); 
                            if (resp.data.success) {
                                alert("M√£ x√°c th·ª±c ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi email!");
                            } else {
                                alert("Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n. L·ªói t·ª´ m√°y ch·ªß!");
                            }
                        })
                        .catch(error => {
                            console.error(error); 
                            alert("Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n!");
                        });
                } else {
                    alert("Vui l√≤ng nh·∫≠p email!");
                }
            };

 //------------------------------------------------------------------------------------------------           

            // h√†m ƒëƒÉng k√Ω t√†i kho·∫£n c√≥ check form
            $scope.register = async function () {
                try {
                    if ($scope.form.password !== $scope.form.confirmPassword) {
                        alert("M·∫≠t kh·∫©u kh√¥ng kh·ªõp, vui l√≤ng nh·∫≠p l·∫°i.");
                        return;
                    }

                    if ($scope.form.username && $scope.form.password && $scope.form.fullname && $scope.form.email && $scope.form.verificationCode) {
                        const item = angular.copy($scope.form);
                        const resp = await $http.post('/rest/accounts/register?code=' + $scope.form.verificationCode, item);
                        console.log(resp.data);

                        if (resp.data.success) {
                            alert("ƒêƒÉng k√Ω th√†nh c√¥ng üéâ!");
                            $scope.reset();
                            window.location.href = "/security/login/form";
                        } else {
                            alert("M√£ x√°c th·ª±c kh√¥ng ch√≠nh x√°c ho·∫∑c th√¥ng tin kh√¥ng h·ª£p l·ªá!");
                        }
                    } else {
                        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    }
                } catch (error) {
                    console.error(error);
                    alert("L·ªói kh√¥ng x√°c ƒë·ªãnh!");
                }
            };

//-------------------------------------------------------------------------------------------

            $scope.suggestedFullname = null;

            // H√†m t·∫°o g·ª£i √Ω t√™n
            $scope.suggestFullname = function () {
                if ($scope.form.username) {
                    const username = $scope.form.username;
                    const capitalizedFullname = username.charAt(0).toUpperCase() + username.slice(1);
                    const randomDigits = Math.floor(Math.random() * (99999 - 1 + 1) + 1).toString();
                    $scope.suggestedFullname = capitalizedFullname + " User " + randomDigits;
                } else {
                    $scope.suggestedFullname = null;
                }
            };

           // h√†m ch·ªçn t√™n g·ª£i √Ω n√®
            $scope.applySuggestion = function () {
                if ($scope.suggestedFullname) {
                    $scope.form.fullname = $scope.suggestedFullname;
                    $scope.suggestedFullname = null;
                }
            };


//---------------------------------------------------------------------------------------------------------
            // H√†m reset form
            $scope.reset = function () {
                $scope.form = {};
            };
        });
    </script>
</body>

</html>