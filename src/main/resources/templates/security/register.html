<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>ƒêƒÉng K√Ω T√†i Kho·∫£n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
            background-image: url('https://ben.com.vn/tin-tuc/wp-content/uploads/2020/09/hinh-nen-powerpoint-don-gian-3-1024x576.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }

        .container {
            margin-top: 5%;
        }

        .card-header {
            background-color: #007bff;
        }

        .card-header h5 {
            letter-spacing: 2px;
        }

        .card {
            border-radius: 20px;
            box-shadow: 0px 5px 20px rgba(0, 0, 0, 0.1);
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: none;
        }

        .btn-primary,
        .btn-success {
            width: 100%;
            border-radius: 50px;
            padding: 10px;
        }

        .btn-primary:hover,
        .btn-success:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .suggestion {
            font-size: 0.9rem;
            font-style: italic;
        }
    </style>
</head>

<body ng-app="app">
    <main class="container d-flex justify-content-center align-items-center">
        <form ng-controller="ctrl" ng-submit="register()" class="w-100" style="max-width: 500px;">
            <div class="card">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h5 class="mb-0">ƒêƒÇNG K√ù T√ÄI KHO·∫¢N</h5>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label for="fullname" class="form-label">T√™n ƒë·∫ßy ƒë·ªß:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                            <input id="fullname" name="fullname" ng-model="form.fullname" class="form-control" required
                                ng-change="suggestFullname()">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">T√†i kho·∫£n:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user-circle"></i></span>
                            <input id="username" name="username" ng-model="form.username" class="form-control" required>
                        </div>
                        <!-- Ph·∫ßn hi·ªÉn th·ªã g·ª£i √Ω d∆∞·ªõi √¥ nh·∫≠p -->
                        <div ng-if="suggestedFullname" class="suggestion text-primary mt-2" style="cursor: pointer;"
                            ng-click="applySuggestion()">
                            T√™n G·ª£i √Ω: {{ suggestedFullname }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">M·∫≠t kh·∫©u:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input id="password" name="password" type="password" ng-model="form.password"
                                class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input id="confirmPassword" name="confirmPassword" type="password"
                                ng-model="form.confirmPassword" class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            <input id="email" name="email" ng-model="form.email" type="email" class="form-control"
                                required>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" ng-click="sendCode()"> <i
                                class="fa-brands fa-google"></i> L·∫•y m√£ x√°c
                            nh·∫≠n</button>
                    </div>
                    <div class="mb-3">
                        <label for="verificationCode" class="form-label">M√£ x√°c nh·∫≠n:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                            <input id="verificationCode" name="verificationCode" ng-model="form.verificationCode"
                                class="form-control" required>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center py-3">
                    <div>
                        <a href="/security/login/form" style="text-decoration: none;">Tr·ªü v·ªÅ </a>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-success">
                            <i class="fa-solid fa-check"></i> ƒêƒÉng k√Ω</button>
                    </div>
                </div>
            </div>
        </form>
    </main>

    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

    <script>
        const app = angular.module("app", []);

        app.controller("ctrl", function ($scope, $http) {
            $scope.form = {};

            //-------------------------------------------------------------------------------------------------------

            // H√†m g·ª≠i m√£ x√°c nh·∫≠n qua email
            $scope.sendCode = function () {
                if ($scope.form.email) {
                    $http.post('/rest/accounts/send-code?email=' + $scope.form.email)
                        .then(resp => {
                            console.log(resp.data);
                            if (resp.data.success) {
                                alert("M√£ x√°c th·ª±c ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi email!");
                            } else {
                                alert("Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n. L·ªói t·ª´ m√°y ch·ªß!");
                            }
                        })
                        .catch(error => {
                            console.error(error);
                            alert("Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n!");
                        });
                } else {
                    alert("Vui l√≤ng nh·∫≠p email!");
                }
            };

            //------------------------------------------------------------------------------------------------           

            // h√†m ƒëƒÉng k√Ω t√†i kho·∫£n c√≥ check form
            $scope.register = async function () {
                try {
                    if ($scope.form.password !== $scope.form.confirmPassword) {
                        alert("M·∫≠t kh·∫©u kh√¥ng kh·ªõp, vui l√≤ng nh·∫≠p l·∫°i.");
                        return;
                    }

                    if ($scope.form.username && $scope.form.password && $scope.form.fullname && $scope.form.email && $scope.form.verificationCode) {
                        const item = angular.copy($scope.form);
                        const resp = await $http.post('/rest/accounts/register?code=' + $scope.form.verificationCode, item);
                        console.log(resp.data);

                        if (resp.data.success) {
                            alert("ƒêƒÉng k√Ω th√†nh c√¥ng üéâ!");
                            $scope.reset();
                            window.location.href = "/security/login/form";
                        } else {
                            alert("M√£ x√°c th·ª±c kh√¥ng ch√≠nh x√°c ho·∫∑c th√¥ng tin kh√¥ng h·ª£p l·ªá!");
                        }
                    } else {
                        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    }
                } catch (error) {
                    console.error(error);
                    alert("L·ªói tr√πng email ho·∫∑c username!");
                }
            };

            //-------------------------------------------------------------------------------------------


            $scope.suggestedFullname = null;

            // H√†m t·∫°o g·ª£i √Ω t√™n
            $scope.suggestFullname = function () {
                if ($scope.form.fullname) {
                    const fullname = $scope.form.fullname.trim();
                    const nameParts = fullname.split(" ");

                    let usernameSuggestion = "";

                    if (nameParts.length > 1) {
                        // L·∫•y to√†n b·ªô t·ª´ cu·ªëi c√πng
                        usernameSuggestion = nameParts[nameParts.length - 1];

                        // L·∫•y k√Ω t·ª± ƒë·∫ßu ti√™n c·ªßa m·ªói t·ª´ (tr·ª´ t·ª´ cu·ªëi c√πng)
                        for (let i = 0; i < nameParts.length - 1; i++) {
                            usernameSuggestion += nameParts[i].charAt(0);
                        }
                    } else {
                        // N·∫øu ch·ªâ c√≥ 1 t·ª´, l·∫•y to√†n b·ªô t·ª´ ƒë√≥
                        usernameSuggestion = nameParts[0];
                    }

                    // H√†m ki·ªÉm tra xem username c√≥ t·ªìn t·∫°i trong h·ªá th·ªëng kh√¥ng
                    function checkUsernameAvailability(suggestedUsername) {
                        return $http.get('/rest/accounts/check-username?username=' + suggestedUsername)
                            .then(resp => {
                                return resp.data.exists; // Gi·∫£ s·ª≠ server tr·∫£ v·ªÅ { exists: true/false }
                            })
                            .catch(() => false); // N·∫øu c√≥ l·ªói th√¨ coi nh∆∞ kh√¥ng t·ªìn t·∫°i
                    }

                    // Ki·ªÉm tra xem t√™n g·ª£i √Ω ƒë√£ t·ªìn t·∫°i ch∆∞a
                    (async function () {
                        let availableUsername = usernameSuggestion.toLowerCase();
                        let count = 1;

                        // Ki·ªÉm tra username ban ƒë·∫ßu
                        let exists = await checkUsernameAvailability(availableUsername);

                        // N·∫øu ƒë√£ t·ªìn t·∫°i, th√™m s·ªë v√† ki·ªÉm tra ti·∫øp
                        while (exists) {
                            availableUsername = usernameSuggestion.toLowerCase() + count;
                            exists = await checkUsernameAvailability(availableUsername);
                            count++;
                        }

                        // C·∫≠p nh·∫≠t l·∫°i g·ª£i √Ω t√™n ng∆∞·ªùi d√πng
                        $scope.suggestedFullname = availableUsername;
                    })();

                } else {
                    $scope.suggestedFullname = null;
                }
            };

            // h√†m ch·ªçn t√™n g·ª£i √Ω n√®
            $scope.applySuggestion = function () {
                if ($scope.suggestedFullname) {
                    $scope.form.username = $scope.suggestedFullname;
                    $scope.suggestedFullname = null;
                }
            };

            //---------------------------------------------------------------------------------------------------------
            // H√†m reset form
            $scope.reset = function () {
                $scope.form = {};
            };
        });
    </script>
</body>

</html>