<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>ƒê·ªïi M·∫≠t Kh·∫©u</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
            background-image: url('https://ben.com.vn/tin-tuc/wp-content/uploads/2020/09/hinh-nen-powerpoint-don-gian-3-1024x576.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }

        .container {
            margin-top: 5%;
        }

        .card-header {
            background-color: #007bff;
        }

        .card-header h5 {
            letter-spacing: 2px;
        }

        .card {
            border-radius: 20px;
            box-shadow: 0px 5px 20px rgba(0, 0, 0, 0.1);
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: none;
        }

        .btn-primary,
        .btn-success {
            width: 100%;
            border-radius: 50px;
            padding: 10px;
        }

        .btn-primary:hover,
        .btn-success:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .suggestion {
            font-size: 0.9rem;
            font-style: italic;
        }
    </style>
</head>

<body ng-app="app">
    <main class="container d-flex justify-content-center align-items-center">
        <form ng-controller="ctrl" ng-submit="changePassword()" class="w-100" style="max-width: 500px;">
            <div class="card">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h5 class="mb-0">ƒê·ªîI M·∫¨T KH·∫®U</h5>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            <input id="email" name="email" ng-model="form.email" type="email" class="form-control"
                                required>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" ng-click="sendCode()"> <i
                                class="fa-brands fa-google"></i> L·∫•y m√£ x√°c nh·∫≠n</button>
                    </div>
                    <div class="mb-3">
                        <label for="verificationCode" class="form-label">M√£ x√°c nh·∫≠n:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-key"></i></span>
                            <input id="verificationCode" name="verificationCode" ng-model="form.verificationCode"
                                class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">M·∫≠t kh·∫©u m·ªõi:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input id="newPassword" name="newPassword" type="password" ng-model="form.newPassword"
                                class="form-control" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmNewPassword" class="form-label">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                            <input id="confirmNewPassword" name="confirmNewPassword" type="password"
                                ng-model="form.confirmNewPassword" class="form-control" required>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center py-3">
                    <div>
                        <a href="/security/login/form" style="text-decoration: none;">Tr·ªü v·ªÅ </a>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-success">
                            <i class="fa-solid fa-check"></i> ƒê·ªïi m·∫≠t kh·∫©u</button>
                    </div>
                </div>
            </div>
        </form>
    </main>

    <!-- AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

    <script>
        const app = angular.module("app", []);

        app.controller("ctrl", function ($scope, $http) {
            $scope.form = {};

            //-------------------------------------------------------------------------------------------------------

            // H√†m g·ª≠i m√£ x√°c nh·∫≠n qua email
            $scope.sendCode = function () {
                if ($scope.form.email) {
                    $http.post('/rest/accounts/send-code?email=' + $scope.form.email)
                        .then(resp => {
                            console.log(resp.data);
                            if (resp.data.success) {
                                alert("M√£ x√°c th·ª±c ƒë√£ ƒë∆∞·ª£c g·ª≠i t·ªõi email!");
                            } else {
                                alert("Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n. L·ªói t·ª´ m√°y ch·ªß!");
                            }
                        })
                        .catch(error => {
                            console.error(error);
                            alert("Kh√¥ng th·ªÉ g·ª≠i m√£ x√°c nh·∫≠n!");
                        });
                } else {
                    alert("Vui l√≤ng nh·∫≠p email!");
                }
            };

            //------------------------------------------------------------------------------------------------            

            // H√†m thay ƒë·ªïi m·∫≠t kh·∫©u
            $scope.changePassword = async function () {
                try {
                    if ($scope.form.newPassword !== $scope.form.confirmNewPassword) {
                        alert("M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp, vui l√≤ng nh·∫≠p l·∫°i.");
                        return;
                    }

                    if ($scope.form.email && $scope.form.verificationCode && $scope.form.newPassword) {
                        const item = angular.copy($scope.form);
                        const resp = await $http.post('/rest/accounts/change-password?code=' + $scope.form.verificationCode, item);
                        console.log(resp.data);

                        if (resp.data.success) {
                            alert("M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi th√†nh c√¥ng üéâ!");
                            $scope.reset();
                            window.location.href = "/security/login/form";
                        } else {
                            alert("M√£ x√°c th·ª±c kh√¥ng ch√≠nh x√°c ho·∫∑c th√¥ng tin kh√¥ng h·ª£p l·ªá!");
                        }
                    } else {
                        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    }
                } catch (error) {
                    console.error(error);
                    alert("ƒê√£ x·∫£y ra l·ªói!");
                }
            };

            //---------------------------------------------------------------------------------------------------------
            // H√†m reset form
            $scope.reset = function () {
                $scope.form = {};
            };
        });
    </script>
</body>

</html>
